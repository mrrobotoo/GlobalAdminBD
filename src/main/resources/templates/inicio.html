<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    .btn-descargar {
        float: left;
        margin-left: 10px;
        background-color: #3498db;
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-eliminar {
        float: right;
        margin-right: 10px;
        background-color: #e74c3c;
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .popup {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .popup-heading {
        text-align: center;
        margin-bottom: 20px;
        font-size: 28px;
        color: #fff;
    }

    .popup-content,
    .popup-content2 {
        background-color: #f1f1f1;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        position: relative;
    }

    .pagination-popup {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination-popup .btn,
    .pagination .page-link {
        margin: 0 5px;
        padding: 8px 16px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        color: #333;
        transition: background-color 0.3s, color 0.3s;
        cursor: pointer;
    }

    .pagination-popup .page-numbers,
    .pagination .page-link {
        margin: 0 5px;
        font-size: 18px;
        font-weight: bold;
    }

    .pagination-popup .btn:hover,
    .pagination .page-link:hover {
        background-color: #ccc;
        color: #000;
    }

    .pagination-popup .btn-prev-page,
    .pagination-popup .btn-next-page,
    .pagination .page-link {
        background-color: #9b59b6;
        border-color: #9b59b6;
        color: #fff;
        font-weight: bold;
    }

    .pagination-popup .btn-prev-page:hover,
    .pagination-popup .btn-next-page:hover,
    .pagination .page-link:hover {
        background-color: #8e44ad;
        border-color: #8e44ad;
    }

    .close {
        color: #ecf0f1;
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #bdc3c7;
        text-decoration: none;
    }

    .form-row {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
    }

    .form-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        color: #333;
    }

    .form-actions {
        text-align: right;
        margin-top: 20px;
    }

    .form-actions button {
        padding: 10px 20px;
        background-color: #e67e22;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .pagination .page-item.disabled .page-link {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .pagination .page-item.active .page-link {
        background-color: #2c3e50;
    }
</style>




</head>

<body>
	<div th:include="navbar.html"></div>
	<div class="container">
		<table class="table">
			<thead>
				<tr>
					<th>Edad</th>
					<th>Nombre</th>
					<th>Sexo</th>
					<td style="text-align: right;">
			<form action="/exportar-pdf-zip" method="get" style="text-align: right;">
    <button style="margin-right: 10px;">Exportar</button>
    <button type="button" class="btn btn-primary" onclick="abrirPopup2()">Descargar</button>
</form>
				</tr>
			</thead>
			<tbody>
				<tr th:each="item, index : ${listaPersonas}" th:data-idUser="${item.idUser}"
					th:data-index="${index.index}">
					<td th:text="${item.age}"></td>
					<td th:text="${item.name}"></td>
					<td th:text="${item.sex}"></td>
					<td>
						<a th:href="@{/eliminar/{idUser}(idUser=${item.idUser})}" class="btn btn-danger">Eliminar</a>
					</td>
					<td>
						<button class="btn btn-primary btn-actualizar">Actualizar</button>
					</td>
				</tr>
			</tbody>
		</table>

		<div id="popup" class="popup">
			<div class="popup-content">
				<a onclick="closePopup()" title="Close" class="close">X</a>
				<div class="popup-heading">
					<h3>Actualizar</h3>
				</div>
				<form method="put" id="formupdt">
					<div class="form-row">
						<label for="popup-edad" class="form-label">Edad:</label>
						<input type="number" class="form-input" id="agenew" name="age" placeholder="age" required>
					</div>
					<div class="form-row">
						<label for="popup-nombre" class="form-label">Nombre:</label>
						<input type="text" class="form-input" id="namenew" name="name" placeholder="name" required>
					</div>
					<div class="form-row">
						<label for="popup-sexo" class="form-label">Sexo:</label>
						<input type="text" class="form-input" id="sexnew" name="sex" placeholder="sex" required>
					</div>
					<div class="form-actions">
						<button type="submit" class="btn btn-info guardar">Actualizar</button>
					</div>
				</form>
			</div>
		</div>


		<nav aria-label="Page navigation">
			<ul class="pagination justify-content-end">
				<!-- Botón para ir a la primera página -->
				<li th:if="${currentPage > 0}" class="page-item">
					<a class="page-link" th:href="@{/inicio(page=0)}">&laquo;&laquo;</a>
				</li>

				<!-- Enlace a la página anterior -->
				<li th:if="${currentPage > 0}" class="page-item">
					<a class="page-link" th:href="@{/inicio(page=${currentPage - 1})}">&laquo;</a>
				</li>

				<!-- Enlaces a las páginas -->
				<li th:each="pageNumber : ${#numbers.sequence(startPageIndex, endPageIndex)}" class="page-item">
					<a th:class="${pageNumber == currentPage ? 'page-link disabled' : 'page-link'}"
						th:href="@{/inicio(page=${pageNumber})}" th:text="${pageNumber + 1}"></a>
				</li>

				<!-- Enlace a la página siguiente -->
				<li th:if="${currentPage < totalPages - 1}" class="page-item">
					<a class="page-link" th:href="@{/inicio(page=${currentPage + 1})}">&raquo;</a>
				</li>

				<!-- Botón para ir a la última página -->
				<li th:if="${currentPage < totalPages - 1}" class="page-item">
					<a class="page-link" th:href="@{/inicio(page=${totalPages - 1})}">&raquo;&raquo;</a>
				</li>
			</ul>
		</nav>



		<!-- Popup para Gestión de Descargas -->
		<div id="popup2" class="popup">
			<div class="popup-content2">
				<div class="archivo-zip-descargados">
					<table class="table table-bordered">
						<thead>
							<tr>
								<th>Archivo ZIP</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody>
							<!-- Itera sobre los nombres de archivos .zip y crea una fila por cada uno -->
							<tr th:each="nombreArchivo : ${nombresArchivos}">
								<div class="d-flex  align-items-center">
									<th><span>${nombreArchivo}</span></th>
									<th><a href="javascript:void(0);"
											class="btn btn-primary btn-descargar btn-separator"
											data-nombre-archivo="${nombreArchivo}">Descargar</a></th>
									<th><a href="javascript:void(0);" class="btn btn-danger btn-eliminar"
											data-nombre-archivo="${nombreArchivo}">Eliminar</a></th>
								</div>
				</div>
				</tr>
				</tbody>
				</table>

			</div>
			<!-- Paginación -->
			<nav class="pagination-popup" aria-label="Page navigation">
				<ul class="pagination justify-content-center">
					<li class="page-item">
						<a class="btn btn-prev-page" href="javascript:void(0);"
							onclick="cambiarPaginaPopup2(currentPage - 1)" id="btnPrevPage">Anterior</a>
					</li>
					<li class="page-item">
						<a class="btn btn-next-page" href="javascript:void(0);"
							onclick="cambiarPaginaPopup2(currentPage + 1)" id="btnNextPage">Siguiente</a>
					</li>
				</ul>
			</nav>

			<div class="form-actions mt-3">
				<button type="button" class="btn btn-secondary btn-cancelar-popup2">Cancelar</button>
			</div>
		</div>
	</div>


	<div th:include="footer.html"></div>

	<script>

		var currentPage = 0;
		var pageSize = 5;
		var totalArchivos = 0; // Variable para almacenar el total de archivos

		function abrirPopup2() {
			var popup2 = document.getElementById("popup2");
			popup2.style.display = "block";

			var btnCancelarPopup2 = document.querySelector('.btn-cancelar-popup2');
			btnCancelarPopup2.addEventListener('click', function () {
				cerrarPopup2();
			});

			obtenerNombresArchivosZipDescargados();
		}

		function cerrarPopup2() {
			var popup2 = document.getElementById("popup2");
			popup2.style.display = "none";
		}

		function eliminarArchivoZip(nombreArchivo) {
			fetch('/eliminarArchivo/' + nombreArchivo, {
				method: 'POST'
			})
				.then(response => response.json())
				.then(data => {
					console.log(data.mensaje);
					obtenerNombresArchivosZipDescargados();
				})
				.catch(error => console.error('Error al eliminar el archivo ZIP:', error));
		}

		function obtenerNombresArchivosZipDescargados() {
			fetch('/obtener-nombres-zip-descargados-popup2?page=' + currentPage)
				.then(response => response.json())
				.then(data => {
					totalArchivos = data.totalPages * pageSize;
					mostrarNombresArchivos(data.archivosPaginados);
				})
				.catch(error => console.error('Error al obtener los nombres de archivos ZIP:', error));
		}

		function mostrarNombresArchivos(nombresArchivos) {
			var tbody = document.querySelector('.archivo-zip-descargados tbody');
			tbody.innerHTML = '';

			nombresArchivos.forEach(nombreArchivo => {
				var tr = document.createElement('tr');
				var tdNombre = document.createElement('td');
				tdNombre.textContent = nombreArchivo;
				tr.appendChild(tdNombre);

				var tdAcciones = document.createElement('td');
				var btnDescargar = document.createElement('a');
				btnDescargar.href = '/descargar-zip/' + nombreArchivo;
				btnDescargar.textContent = 'Descargar';
				btnDescargar.classList.add('btn', 'btn-primary', 'btn-descargar');
				tdAcciones.appendChild(btnDescargar);

				var btnEliminar = document.createElement('a');
				btnEliminar.href = 'javascript:void(0);';
				btnEliminar.textContent = 'Eliminar';
				btnEliminar.classList.add('btn', 'btn-danger', 'btn-eliminar');
				btnEliminar.setAttribute('data-nombre-archivo', nombreArchivo);
				btnEliminar.addEventListener('click', function () {
					var nombreArchivo = this.getAttribute('data-nombre-archivo');
					eliminarArchivoZip(nombreArchivo);
				});
				tdAcciones.appendChild(btnEliminar);

				tr.appendChild(tdAcciones);
				tbody.appendChild(tr);
			});

			actualizarPaginacionPopup2();
		}

		function cambiarPaginaPopup2(pagina) {
			currentPage = pagina;
			obtenerNombresArchivosZipDescargados();
		}

		function actualizarPaginacionPopup2() {
			var pagination = document.querySelector('.pagination-popup');
			pagination.innerHTML = '';

			var totalPaginas = Math.ceil(totalArchivos / pageSize);

			var pageNumbers = document.createElement('span');
			pageNumbers.textContent = 'Página ' + (currentPage + 1) + ' de ' + totalPaginas;
			pageNumbers.classList.add('page-numbers');
			pagination.appendChild(pageNumbers);

			var btnPrevPage = document.createElement('button');
			btnPrevPage.textContent = '< Anterior';
			btnPrevPage.classList.add('btn', 'btn-secondary', 'btn-prev-page');
			btnPrevPage.disabled = currentPage === 0;
			btnPrevPage.addEventListener('click', function () {
				if (currentPage > 0) {
					cambiarPaginaPopup2(currentPage - 1);
				}
			});
			pagination.appendChild(btnPrevPage);

			// Resto del código de creación de botones de página

			var btnNextPage = document.createElement('button');
			btnNextPage.textContent = 'Siguiente >';
			btnNextPage.classList.add('btn', 'btn-secondary', 'btn-next-page');
			btnNextPage.disabled = currentPage === totalPaginas - 1 || totalArchivos === 0;
			btnNextPage.addEventListener('click', function () {
				if (currentPage < totalPaginas - 1) {
					cambiarPaginaPopup2(currentPage + 1);
				}
			});
			pagination.appendChild(btnNextPage);
		}

		var popup = document.getElementById("popup");
		var botonesActualizar = document.querySelectorAll('.btn-actualizar');
		var span = document.getElementsByClassName("close")[0];
		var inputsEdad = document.getElementById('agenew');
		var inputsNombre = document.getElementById('namenew');
		var inputsSexo = document.getElementById('sexnew');
		var form = document.getElementById('formupdt');

		botonesActualizar.forEach(function (boton) {
			boton.addEventListener('click', function () {
				var filaSeleccionada = this.parentNode.parentNode;
				var idUser = filaSeleccionada.getAttribute('data-idUser');
				var edad = filaSeleccionada.querySelector('td:nth-child(1)').textContent;
				var nombre = filaSeleccionada.querySelector('td:nth-child(2)').textContent;
				var sexo = filaSeleccionada.querySelector('td:nth-child(3)').textContent;

				inputsEdad.value = edad;
				inputsNombre.value = nombre;
				inputsSexo.value = sexo;

				document.querySelector('.guardar').setAttribute('data-idUser', idUser);

				popup.style.display = "block";
			});
		});

		span.onclick = function () {
			popup.style.display = "none";
		}

		window.onclick = function (event) {
			if (event.target == popup) {
				popup.style.display = "none";
			}
		}

		form.addEventListener('submit', function (event) {
			event.preventDefault();

			var idUser = document.querySelector('.guardar').getAttribute('data-idUser');
			var filaSeleccionada = document.querySelector('tr[data-idUser="' + idUser + '"]');
			var edad = inputsEdad.value;
			var nombre = inputsNombre.value;
			var sexo = inputsSexo.value;

			var data = {
				idUser: idUser,
				name: nombre,
				age: edad,
				sex: sexo
			};

			fetch('/person?idUser=' + idUser, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
				.then(function (response) {
					if (response.ok) {
						filaSeleccionada.querySelector('td:nth-child(1)').textContent = edad;
						filaSeleccionada.querySelector('td:nth-child(2)').textContent = nombre;
						filaSeleccionada.querySelector('td:nth-child(3)').textContent = sexo;
						popup.style.display = "none";
					} else {
						console.error('Error al realizar la petición');
					}
				})
				.catch(function (error) {
					console.error('Error en la petición:', error);
				});
		});

		function closePopup() {
			popup.style.display = "none";
		}
	</script>