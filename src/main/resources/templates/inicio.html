<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		.btn-descargar {
			/* Float the Descargar button to the right */
			float: left;
			margin-left: 1px;
			/* Add some spacing between the buttons */
		}

		.btn-eliminar {
			/* Float the Eliminar button to the left */
			float: right;
			margin-right: 5px;
			/* Add some spacing between the buttons */
		}

		.popup {
			display: none;
			position: fixed;
			z-index: 1;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0, 0, 0, 0.6);
		}

		.popup-heading {
			text-align: center;
		}

		.popup-content {
			background-color: #ccc;
			margin: 10% auto;
			padding: 20px;
			border-radius: 5px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
			max-width: 400px;
			position: relative;
		}

		.popup-content2 {
			background-color: #ccc;
			margin: 10% auto;
			padding: 20px;
			border-radius: 5px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
			max-width: 600px;
			position: relative;
		}

		.close {
			color: #E57F7F;
			position: absolute;
			top: 10px;
			right: 10px;
			font-size: 24px;
			font-weight: bold;
			cursor: pointer;
		}

		.close:hover,
		.close:focus {
			color: #FF0000;
			text-decoration: none;
		}

		.form-row {
			margin-bottom: 10px;
		}

		.form-label {
			display: block;
			font-weight: bold;
			margin-bottom: 5px;
		}

		.form-input {
			width: 100%;
			padding: 8px;
			border: 1px solid #ccc;
			border-radius: 3px;
		}

		.form-actions {
			text-align: right;
			margin-top: 20px;
		}

		.form-actions button {
			padding: 8px 16px;
			background-color: rgb(0, 0, 255);
			color: #fff;
			border: none;
			border-radius: 3px;
			cursor: pointer;
		}

		.pagination-popup {
			display: flex;
			justify-content: center;
			margin-top: 20px;
		}

		.pagination {
			display: flex;
			justify-content: center;
			margin-top: 20px;
		}

		.pagination .page-link {
			color: #ffffff;
			background-color: #333333;
			border: none;
			padding: 8px 16px;
			margin: 0 4px;
			border-radius: 4px;
			text-decoration: none;
			transition: background-color 0.3s;
		}

		.pagination .page-link:hover {
			background-color: #555555;
		}

		.pagination .page-link:focus {
			outline: none;
			box-shadow: none;
		}

		.pagination .page-item.disabled .page-link {
			opacity: 0.6;
			cursor: not-allowed;
		}

		.pagination .page-item.active .page-link {
			background-color: #007bff;
		}
	</style>
</head>

<body>
	<div th:include="navbar.html"></div>
	<div class="container">
		<table class="table">
			<thead>
				<tr>
					<th>Edad</th>
					<th>Nombre</th>
					<th>Sexo</th>
					<th> <button type="button" class="btn btn-warning" onclick="abrirPopup2()">Descargas</button></th>
					<th><a href="/exportar-pdf-zip">Exportar a PDF y ZIP</a></th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="item, index : ${listaPersonas}" th:data-idUser="${item.idUser}"
					th:data-index="${index.index}">
					<td th:text="${item.age}"></td>
					<td th:text="${item.name}"></td>
					<td th:text="${item.sex}"></td>
					<td>
						<a th:href="@{/eliminar/{idUser}(idUser=${item.idUser})}" class="btn btn-danger">Eliminar</a>
					</td>
					<td>
						<button class="btn btn-primary btn-actualizar">Actualizar</button>
					</td>
				</tr>
			</tbody>
		</table>

		<div id="popup" class="popup">
			<div class="popup-content">
				<a onclick="closePopup()" title="Close" class="close">X</a>
				<div class="popup-heading">
					<h3>Actualizar Usuario</h3>
				</div>
				<form method="put" id="formupdt">
					<div class="form-row">
						<label for="popup-edad" class="form-label">Edad:</label>
						<input type="number" class="form-input" id="agenew" name="age" placeholder="age" required>
					</div>
					<div class="form-row">
						<label for="popup-nombre" class="form-label">Nombre:</label>
						<input type="text" class="form-input" id="namenew" name="name" placeholder="name" required>
					</div>
					<div class="form-row">
						<label for="popup-sexo" class="form-label">Sexo:</label>
						<input type="text" class="form-input" id="sexnew" name="sex" placeholder="sex" required>
					</div>
					<div class="form-actions">
						<button type="submit" class="btn btn-info guardar">Actualizar</button>
					</div>
				</form>
			</div>
		</div>


		<nav aria-label="Page navigation">
			<ul class="pagination justify-content-end">
				<!-- Botón para ir a la primera página -->
				<li th:if="${currentPage > 0}" class="page-item">
					<a class="page-link" th:href="@{/inicio(page=0)}">&laquo;&laquo;</a>
				</li>

				<!-- Enlace a la página anterior -->
				<li th:if="${currentPage > 0}" class="page-item">
					<a class="page-link" th:href="@{/inicio(page=${currentPage - 1})}">&laquo;</a>
				</li>

				<!-- Enlaces a las páginas -->
				<li th:each="pageNumber : ${#numbers.sequence(startPageIndex, endPageIndex)}" class="page-item">
					<a th:class="${pageNumber == currentPage ? 'page-link disabled' : 'page-link'}"
						th:href="@{/inicio(page=${pageNumber})}" th:text="${pageNumber + 1}"></a>
				</li>

				<!-- Enlace a la página siguiente -->
				<li th:if="${currentPage < totalPages - 1}" class="page-item">
					<a class="page-link" th:href="@{/inicio(page=${currentPage + 1})}">&raquo;</a>
				</li>

				<!-- Botón para ir a la última página -->
				<li th:if="${currentPage < totalPages - 1}" class="page-item">
					<a class="page-link" th:href="@{/inicio(page=${totalPages - 1})}">&raquo;&raquo;</a>
				</li>
			</ul>
		</nav>



		<!-- Popup para Gestión de Descargas -->
		<div id="popup2" class="popup">
			<div class="popup-content2">
				<h2>Gestor de Descargas</h2>
				<div class="archivo-zip-descargados">
					<table class="table table-bordered">
						<thead>
							<tr>
								<th>Nombre de Archivo ZIP</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody>
							<!-- Itera sobre los nombres de archivos .zip y crea una fila por cada uno -->
							<tr th:each="nombreArchivo : ${nombresArchivos}">
								<div class="d-flex  align-items-center">
									<th><span>${nombreArchivo}</span></th>
									<th><a href="javascript:void(0);"
											class="btn btn-primary btn-descargar btn-separator"
											data-nombre-archivo="${nombreArchivo}">Descargar</a></th>
									<th><a href="javascript:void(0);" class="btn btn-danger btn-eliminar"
											data-nombre-archivo="${nombreArchivo}">Eliminar</a></th>
								</div>
				</div>
				</tr>
				</tbody>
				</table>

			</div>
			<!-- Paginación -->
			<nav class="pagination-popup" aria-label="Page navigation">
				<ul class="pagination justify-content-center">
					<li class="page-item">
						<a class="btn btn-prev-page" href="javascript:void(0);"
							onclick="cambiarPaginaPopup2(currentPage - 1)" id="btnPrevPage">Anterior</a>
					</li>
					<li class="page-item">
						<span class="page-numbers mx-3" id="pageNumbers">Página 1 de 1</span>
					</li>
					<li class="page-item">
						<a class="btn btn-next-page" href="javascript:void(0);"
							onclick="cambiarPaginaPopup2(currentPage + 1)" id="btnNextPage">Siguiente</a>
					</li>
				</ul>
			</nav>

			<div class="form-actions mt-3">
				<button type="button" class="btn btn-secondary btn-cancelar-popup2">Cancelar</button>
			</div>
		</div>
	</div>


	<div th:include="footer.html"></div>

	<script>

		var currentPage = 0;
		var pageSize = 5;
		var totalArchivos = 1; // Variable para almacenar el total de archivos

		// Función para abrir el "popup2"
		function abrirPopup2() {
			var popup2 = document.getElementById("popup2");
			popup2.style.display = "block";

			// Agregar un evento de clic al botón "Cancelar" dentro del "popup2" para cerrarlo
			var btnCancelarPopup2 = document.querySelector('.btn-cancelar-popup2');
			btnCancelarPopup2.addEventListener('click', function () {
				cerrarPopup2();
			});

			// Obtener los nombres de los archivos ZIP descargados mediante una solicitud AJAX al controlador
			obtenerNombresArchivosZipDescargados();
		}

		// Función para cerrar el "popup2"
		function cerrarPopup2() {
			var popup2 = document.getElementById("popup2");
			popup2.style.display = "none";
		}

		// Función para eliminar un archivo ZIP
		function eliminarArchivoZip(nombreArchivo) {
			// Realizar una solicitud AJAX para eliminar el archivo ZIP en el servidor
			fetch('/eliminarArchivo/' + nombreArchivo, {
				method: 'POST'
			})
				.then(response => response.json())
				.then(data => {
					// Mostrar un mensaje o realizar alguna acción después de eliminar el archivo
					console.log(data.mensaje);
					// Volver a obtener los nombres de archivos después de eliminar
					obtenerNombresArchivosZipDescargados();
				})
				.catch(error => console.error('Error al eliminar el archivo ZIP:', error));
		}

		// Función para obtener los nombres de archivos ZIP descargados
		function obtenerNombresArchivosZipDescargados() {
			fetch('/obtener-nombres-zip-descargados')
				.then(response => response.json())
				.then(data => {
					totalArchivos = data.length; // Actualizar el total de archivos
					mostrarNombresArchivos(data);
				})
				.catch(error => console.error('Error al obtener los nombres de archivos ZIP:', error));
		}

		function mostrarNombresArchivos(nombresArchivos) {
			var tbody = document.querySelector('.archivo-zip-descargados tbody');
			tbody.innerHTML = '';

			nombresArchivos.forEach(nombreArchivo => {
				var tr = document.createElement('tr');
				var tdNombre = document.createElement('td');
				tdNombre.textContent = nombreArchivo;
				tr.appendChild(tdNombre);

				var tdAcciones = document.createElement('td');
				var btnDescargar = document.createElement('a');
				btnDescargar.href = '/descargar-zip/' + nombreArchivo;
				btnDescargar.textContent = 'Descargar';
				btnDescargar.classList.add('btn', 'btn-primary', 'btn-descargar');
				tdAcciones.appendChild(btnDescargar);

				var btnEliminar = document.createElement('a');
				btnEliminar.href = 'javascript:void(0);';
				btnEliminar.textContent = 'Eliminar';
				btnEliminar.classList.add('btn', 'btn-danger', 'btn-eliminar');
				btnEliminar.setAttribute('data-nombre-archivo', nombreArchivo);
				btnEliminar.addEventListener('click', function () {
					var nombreArchivo = this.getAttribute('data-nombre-archivo');
					eliminarArchivoZip(nombreArchivo);
				});
				tdAcciones.appendChild(btnEliminar);

				tr.appendChild(tdAcciones);
				tbody.appendChild(tr);
			});

			actualizarPaginacionPopup2();
		}

		function cambiarPaginaPopup2(pagina) {
			currentPage = pagina;
			obtenerNombresArchivosZipDescargados();
		}

		function cambiarPaginaPopup2(pagina) {
    console.log("Changing page to", pagina);
    currentPage = pagina;
    obtenerNombresArchivosZipDescargados();
}

// ...

btnPrevPage.addEventListener('click', function () {
    console.log("Prev page clicked");
    if (currentPage > 0) {
        cambiarPaginaPopup2(currentPage - 1);
    }
});

btnNextPage.addEventListener('click', function () {
    console.log("Next page clicked");
    if (currentPage < totalPaginas - 1) {
        cambiarPaginaPopup2(currentPage + 1);
    }
}); 
		obtenerNombresArchivosZipDescargados();


		var popup = document.getElementById("popup");
		var botonesActualizar = document.querySelectorAll('.btn-actualizar');
		var span = document.getElementsByClassName("close")[0];
		var inputsEdad = document.getElementById('agenew');
		var inputsNombre = document.getElementById('namenew');
		var inputsSexo = document.getElementById('sexnew');
		var form = document.getElementById('formupdt');

		botonesActualizar.forEach(function (boton) {
			boton.addEventListener('click', function () {
				var filaSeleccionada = this.parentNode.parentNode;
				var idUser = filaSeleccionada.getAttribute('data-idUser');
				var edad = filaSeleccionada.querySelector('td:nth-child(1)').textContent;
				var nombre = filaSeleccionada.querySelector('td:nth-child(2)').textContent;
				var sexo = filaSeleccionada.querySelector('td:nth-child(3)').textContent;

				inputsEdad.value = edad;
				inputsNombre.value = nombre;
				inputsSexo.value = sexo;

				document.querySelector('.guardar').setAttribute('data-idUser', idUser);

				popup.style.display = "block";
			});
		});

		span.onclick = function () {
			popup.style.display = "none";
		}

		window.onclick = function (event) {
			if (event.target == popup) {
				popup.style.display = "none";
			}
		}

		form.addEventListener('submit', function (event) {
			event.preventDefault();

			var idUser = document.querySelector('.guardar').getAttribute('data-idUser');
			var filaSeleccionada = document.querySelector('tr[data-idUser="' + idUser + '"]');
			var edad = inputsEdad.value;
			var nombre = inputsNombre.value;
			var sexo = inputsSexo.value;

			var data = {
				idUser: idUser,
				name: nombre,
				age: edad,
				sex: sexo
			};

			fetch('/person?idUser=' + idUser, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
				.then(function (response) {
					if (response.ok) {
						filaSeleccionada.querySelector('td:nth-child(1)').textContent = edad;
						filaSeleccionada.querySelector('td:nth-child(2)').textContent = nombre;
						filaSeleccionada.querySelector('td:nth-child(3)').textContent = sexo;
						popup.style.display = "none";
					} else {
						console.error('Error al realizar la petición');
					}
				})
				.catch(function (error) {
					console.error('Error en la petición:', error);
				});
		});

		function closePopup() {
			popup.style.display = "none";
		}
	</script>