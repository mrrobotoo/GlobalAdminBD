<!DOCTYPE html>
<html lang="en">

<head>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
		crossorigin="anonymous"></script>
	<link rel="stylesheet" href="styles.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
	<title>Registros</title>
	<style>
		/* ESTILOS PARA LOS BOTONES DE DESCARGAR Y ELIMINAR DENTRO DEL MODAL DE DESCARGAS */
		#modalDescargas .btn {
			padding: 5px 10px;
			font-size: 14px;
		}

		#modalDescargas .btn-descargar {
			background-color: #28a745;
			color: #fff;
		}

		#modalDescargas .btn-descargar:hover {
			background-color: #218838;
			align-items: center;
		}

		#modalDescargas .btn-eliminar {
			background-color: #dc3545;
			color: #fff;
		}

		#modalDescargas .btn-eliminar:hover {
			background-color: #c82333;
		}
	</style>

</head>

<body>
	<div th:include="navbar.html"></div> <!-- IMPORTAMOS EL NAVBAR -->
	<div style="align-items: center;">
		<form action="/buscar" method="get" style="background-color: #212529;">
			<b style="color: white; padding-left: 20px; padding-right: 10px;">Filtrar: </b>
			<input type="text" name="nombre" placeholder="Buscar por nombre"
				style="text-align: center; margin-top: 15px;">
			<input type="submit" value="Buscar" class="btn btn-info"
				style="padding-left: 7px; padding-right: 7px; padding-top: 2px; padding-bottom: 2px; margin-bottom: 3px;">
		</form>
	</div>
	<table class="table table-dark" id="data-table" style="margin-bottom: 3.95%;">
		<thead class="thead-dark">
			<tr>
				<th style="text-align: center;">Nombre</th>
				<th style="text-align: center;">Edad</th>
				<th style="text-align: center;">Sexo</th>
				<th class="hide-on-pdf">
					<center>
						<a id="export-button" class="btn btn-warning">Exportar</a>
						<!-- BUTTON PARA EXPORTAR CANTIDAD DE ELEMENTOS -->
					</center>
				</th>
				<th class="hide-on-pdf">
					<center>
						<button class="btn btn-success" data-bs-toggle="modal"
							data-bs-target="#modalDescargas">Descargas</button> <!-- BUTTON PARA DESCARGAR PDFs -->
					</center>
				</th>
			</tr>
		</thead>
		<tbody>
			<tr th:each="item, itemStatus: ${listaPersonas}">
				<td style="text-align: center;" th:text="${item.nombre}"></td>
				<td style="text-align: center;" th:text="${item.edad}"></td>
				<td style="text-align: center;" th:text="${item.sexo}"></td>
				<!-- BUTTON ELIMINAR PERSONAS -->
				<td class="hide-on-pdf">
					<center>
						<a style="text-align: center;" th:href="@{/eliminar/{id}(id=${item.id})}" class="btn btn-danger"
							onclick="mensajeEliminar()">Eliminar</a>
					</center>

				</td>
				<!-- MODAL -->
				<td class="hide-on-pdf">
					<div>
						<center>
							<button class="btn btn-primary" data-bs-toggle="modal"
								th:data-bs-target="'#modalContainer-' + ${item.id}"
								th:attr="data-id=${item.id}">Actualizar</button>
							<!-- BUTTON ACTUALIZAR PARA CADA FILA -->
						</center>
						<!-- EL 'TH:ATTR' HACE QUE SE LE ASIGNE UN VALOR DINÁMICO AL 'DATA-ID' QUE ES EL ATRIBUTO DE DATOS Y REPRESENTA EL ID ÚNICO DE LA PERSONA DEPENDIENDO DE LA FILA EN LA QUE SE ENCUENTRA EL BOTÓN -->
						<div class="modal fade" th:id="'modalContainer-' + ${item.id}" tabindex="-1" role="dialog"
							aria-labelledby="modalTitle" aria-hidden="true"> <!-- CONTENEDOR DEL MODAL -->
							<div class="modal-dialog" role="document">
								<div class="modal-content"> <!-- CONTENEDOR DE MODAL -->
									<div class="modal-header" style="text-align: center;"> <!-- CABECERA DEL MODAL -->
										<h4 class="modal-title" style="color: black;">Actualizar
											Datos</h4>
										<button type="button" class="btn-close" data-bs-dismiss="modal"
											aria-label="Close"></button> <!-- BUTTON 'X' PARA CERRAR EL MODAL -->
									</div>
									<div class="modal-body"> <!-- CUERPO DEL MODAL -->
										<center> <!-- CENTRAMOS EL CONTENIDO -->
											<form style="max-width: max-content;"
												th:action="@{/actualizar/{id}(id=${item.id})}"
												class="p-3 mb-2 bg-dark text-white" method="post">
												<!-- FORMULARIO PARA ACTUALIZAR -->
												<input type="hidden" name="id" th:value="${item.id}" />
												<!-- CAMPO OCULTO PARA TRAER EL ID DE LA PERSONA -->
												<table border="10px" style="padding: 10px; border-style: solid;">
													<tr>
														<td style="text-align: right; padding: 10px;"><label
																for="nombre" class="label label-primary"
																style="text-align: right">Nombre: </label></td>
														<td style="padding-right: 10px; padding-top: 10px;"><input
																style="text-align: center;" id="NombreInput"
																placeholder="Ingresa un nombre" type="text"
																name="nombre" th:value="${item.nombre}" /></td>
													</tr>
													<tr>
														<td style="text-align: right; padding: 10px;"><label for="edad"
																style="text-align: right">Edad: </label></td>
														<td>
															<input style="text-align: center"
																placeholder="Ingresa la edad" type="text" name="edad"
																th:value="${item.edad}" />
														</td>
													</tr>
													<tr>
														<td style="text-align: right; padding: 10px;">
															<label for="sexo" style="text-align: right">Sexo: </label>
														</td>
														<td>
															<input style="text-align: center" placeholder="H/M/NB"
																type="text" name="sexo" th:value="${item.sexo}" />
														</td>
													</tr>
													<tr>
														<td align="center"></td>
														<td
															style="padding-left: 0px; padding-top: 10px; padding-bottom: 10px;">
															<input type="submit" value="Actualizar"
																class="btn btn-success"
																onclick="mensajeUserActualizado()" />
														</td>
													</tr>
												</table>
											</form>
										</center>
									</div>
								</div>
							</div>
						</div>
					</div>
				</td>
			</tr>
		</tbody>
	</table>

	<!-- PARTE DEL FILTRO -->
	<div th:if="${mensaje}" class="alert alert-warning" role="alert">
		<p th:text="${mensaje}"></p>
	</div>
	<!-- FIN PARTE DE FILTRO -->

	<!-- PAGINADOR CON FILTRO -->

	<div th:if="${esBusqueda}" style="display: none;">
		<div class="d-flex justify-content-center" style="margin-bottom: 10%; position: relative; z-index: 0">
			<div id="paginator-container" class="d-flex justify-content-center"
				style="margin-bottom: 10%; position: relative; z-index: 0">
				<!-- CENTRAR EL PAGINADOR -->
				<ul class="pagination">
					<li th:if="${currentPage > 0}" class="page-item">
						<a class="page-link" th:href="@{/inicio(page=0)}">Inicio</a>
					</li>
					<li th:if="${currentPage > 0}" class="page-item">
						<a class="page-link" th:href="@{/inicio(page=${currentPage - 1})}">Anterior</a>
					</li>
					<li th:each="pageNumber : ${#numbers.sequence(0, totalPages - 1)}"
						th:classappend="${pageNumber} == ${currentPage} ? 'page-item active' : 'page-item'">
						<a class="page-link" th:href="@{/inicio(page=${pageNumber})}" th:text="${pageNumber + 1}"></a>
					</li>
					<li th:if="${currentPage < totalPages - 1}" class="page-item">
						<a class="page-link" th:href="@{/inicio(page=${currentPage + 1})}">Siguiente</a>
					</li>
					<li th:if="${currentPage < totalPages - 1}" class="page-item">
						<a class="page-link" th:href="@{/inicio(page=${totalPages - 1})}">Final</a>
					</li>
				</ul>
			</div>
		</div>
	</div>

	<!-- PARTE PAGINADOR CON FILTRO -->
	<div th:unless="${esBusqueda}">
		<div class="d-flex justify-content-center" style="margin-bottom: 10%; position: relative; z-index: 0">
			<div id="paginator-container" class="d-flex justify-content-center"
				style="margin-bottom: 10%; position: relative; z-index: 0">
				<!-- CENTRAR EL PAGINADOR -->
				<ul class="pagination">
					<li th:if="${currentPage > 0}" class="page-item">
						<a class="page-link" th:href="@{/inicio(page=0)}">Inicio</a>
					</li>
					<li th:if="${currentPage > 0}" class="page-item">
						<a class="page-link" th:href="@{/inicio(page=${currentPage - 1})}">Anterior</a>
					</li>
					<li th:each="pageNumber : ${#numbers.sequence(0, totalPages - 1)}"
						th:classappend="${pageNumber} == ${currentPage} ? 'page-item active' : 'page-item'">
						<a class="page-link" th:href="@{/inicio(page=${pageNumber})}" th:text="${pageNumber + 1}"></a>
					</li>
					<li th:if="${currentPage < totalPages - 1}" class="page-item">
						<a class="page-link" th:href="@{/inicio(page=${currentPage + 1})}">Siguiente</a>
					</li>
					<li th:if="${currentPage < totalPages - 1}" class="page-item">
						<a class="page-link" th:href="@{/inicio(page=${totalPages - 1})}">Final</a>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!-- FIN PAGINADOR CON FILTRO-->

	<!-- MODAL DESCARGAS -->
	<div class="modal fade" id="modalDescargas" tabindex="-1" role="dialog" aria-labelledby="modalDescargasLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modalDescargasLabel">Descargas</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Archivos temporales disponibles:</p>
					<table class="table table-bordered">
						<thead>
							<tr>
								<th style="text-align: center;">Nombre del Archivo</th>
								<th style="text-align: center;">Descargar</th>
								<th style="text-align: center;">Eliminar</th>
							</tr>
						</thead>
						<tbody id="descargaLinkContainer" style="text-align: center; align-items: center;">
							<!-- LAS FILAS DE LA TABLA SE GENERARÁN AQUÍ DE MANERA DÍNAMICA -->
						</tbody>
					</table>
					<ul class="pagination justify-content-center" id="modalPaginator"></ul>
				</div>
			</div>
		</div>
	</div>
	<!-- FIN MODAL DESCARGAS -->

	<div th:include="footer.html"></div> <!-- SE INCLUYE EL FOOTER -->

	<!-- SCRIPT PARA DESCARGAR PDF TEMPORALMENTE -->
	<script>
		//AGREGAMOS EVENTO CLICK AL BOTÓN DE EXPORTAR
		document.getElementById("export-button").addEventListener("click", function () {
			//OBTENEMOS EL NÚMERO DE PÁGINA ACTUAL
			const currentPage = document.querySelector(".page-item.active .page-link").textContent - 1;

			//DEFINIMOS EL VALOR DESEADO PARA LA CANTIDAD DE REGISTROS POR PÁGINA
			const registrosCount = 100; //CANTIDAD DE REGISTROS POR PÁGINA

			//REALIZAMOS LA PETICIÓN AJAX AL SERVIDOR, ENVIANDO EL NÚMERO DE PÁGINA Y REGISTROSCOUNT COMO PARAMETROS.
			fetch(`/exportar?page=${currentPage}&registrosCount=${registrosCount}`, {
				method: 'GET',
			})
				.then(response => {
					//EN CASO DE QUE LA PETICIÓN SEA EXITOSA
					if (response.ok) {
						return response.blob(); //CONVERTIMOS LA RESPUESTA EN UN OBJETO BLOB
					}
					//EN CASO DE QUE LA PETICIÓN FALLE
					throw new Error('Error al exportar la tabla.');
				})
				.then(blob => {
					//CREAMOS EL ENLACE DE DESCARGA EN EL MODAL
					const url = URL.createObjectURL(blob);
					const downloadLink = document.createElement('a');
					downloadLink.href = url;
					downloadLink.download = 'registros.pdf';
					downloadLink.textContent = 'Descargar PDF';
					const descargaLinkContainer = document.getElementById('descargaLinkContainer');
					descargaLinkContainer.innerHTML = ''; //LIMPIAMOS EL CONTENEDOR ANTES DE AGREGAR EL ENLACE
					descargaLinkContainer.appendChild(downloadLink);

					//MOSTRAMOS LA ALERTA DE QUE LOS ARCHIVOS SE HAN GUARDADO TEMPORALMENTE
					alert('Los archivos se han guardado temporalmente. Haz clic en "Descargas" para descargar el PDF.');
				})
				.catch(error => {
					//MOSTRAR EL ERROR EN CASO DE QUE FALLE
					alert(error.message);
				});
		});
	</script>

	<script>
		//FUNCIÓN PARA CARGAR LOS ENLACES DE DESCARGA DENTRO DE LA TABLA DEL MODAL DE DESCARGAS
		function cargarEnlacesDescargas() {
			fetch('/descargas')
				.then(response => response.json())
				.then(data => {
					const descargaLinkContainer = document.getElementById('descargaLinkContainer');
					descargaLinkContainer.innerHTML = '';

					const archivosPorPagina = 5;
					const totalPaginas = Math.ceil(data.length / archivosPorPagina);

					const modalPaginator = document.getElementById('modalPaginator');
					modalPaginator.innerHTML = ''; //LIMPIAMOS EL PAGINADOR ANTES DE RELLENARLO

					for (let pagina = 0; pagina < totalPaginas; pagina++) {
						const paginaItem = document.createElement('li');
						paginaItem.classList.add('page-item');
						const paginaLink = document.createElement('a');
						paginaLink.classList.add('btn', 'page-link');
						paginaLink.textContent = pagina + 1;
						paginaLink.addEventListener('click', () => {
							mostrarArchivosPagina(data, pagina, archivosPorPagina);
						});
						paginaItem.appendChild(paginaLink);
						modalPaginator.appendChild(paginaItem);
					}

					//MOSTRAMOS ARCHIVOS DE LA PRIMERA PÁGINA POR DEFECTO, EN ESTE CASO, ES LA PÁGINA 0.
					mostrarArchivosPagina(data, 0, archivosPorPagina);
				})
				.catch(error => {
					console.error('Error al obtener la lista de archivos temporales:', error);
				});
		}

		function mostrarArchivosPagina(data, pagina, archivosPorPagina) {
			const descargaLinkContainer = document.getElementById('descargaLinkContainer');
			descargaLinkContainer.innerHTML = ''; //LIMPIAMOS LOS ARCHIVOS ACTUALES

			const inicio = pagina * archivosPorPagina;
			const fin = inicio + archivosPorPagina;

			const archivosPagina = data.slice(inicio, fin);

			archivosPagina.forEach(archivo => { //CREACIÓN DE LOS BOTONES DE DESCARGAR Y ELIMINAR PARA CADA FILA DE MANERA DINÁMICA
				const fila = document.createElement('tr');

				const nombreCelda = document.createElement('td');
				nombreCelda.textContent = archivo;
				fila.appendChild(nombreCelda);

				const descargarCelda = document.createElement('td');
				const descargarBoton = document.createElement('button'); //CREACIÓN BOTÓN DESCARGAR
				descargarBoton.textContent = 'Descargar'; //TEXTO BUTTON
				descargarBoton.classList.add('btn', 'btn-descargar'); //CLASES DEL BOTÓN, ESTILO Y FUNCIONALIDAD
				descargarBoton.dataset.nombre = archivo;
				descargarCelda.appendChild(descargarBoton);
				fila.appendChild(descargarCelda);
				descargarBoton.addEventListener('click', () => {
					window.location.href = `/descargas/${archivo}`;
				});
				descargarCelda.appendChild(descargarBoton);
				fila.appendChild(descargarCelda);

				const eliminarCelda = document.createElement('td');
				const eliminarBoton = document.createElement('button'); //CREACIÓN BOTÓN ELIMINAR
				eliminarBoton.textContent = 'Eliminar'; //TEXTO BUTTON
				eliminarBoton.classList.add('btn', 'btn-eliminar'); //CLASES DEL BOTÓN, ESTILO Y FUNCIONALIDAD
				eliminarBoton.addEventListener('click', () => {
					eliminarArchivoTemporal(archivo);
				});
				eliminarCelda.appendChild(eliminarBoton);
				fila.appendChild(eliminarCelda);

				descargaLinkContainer.appendChild(fila);
			});

			//ACTUALIZAMOS CLASES PARA RESALTAR LA PÁGINA ACTIVA DENTRO DEL PAGINADOR
			const modalPaginator = document.getElementById('modalPaginator');
			const paginas = modalPaginator.querySelectorAll('.page-item');
			paginas.forEach((paginaItem, index) => {
				if (index === pagina) {
					paginaItem.classList.add('active');
				} else {
					paginaItem.classList.remove('active');
				}
			});
		}

		//FUNCIÓN PARA ELININAR EL ARCHIVO TEMPORAL EN EL SERVIDOR
		function eliminarArchivoTemporal(archivo) {
			fetch(`/eliminar-archivo?nombre=${archivo}`, {
				method: 'DELETE',
			})
				.then(response => {
					if (response.ok) { //EN CASO DE QUE EL ARCHIVO SE ELIMINE CORRECTAMENTE, ACTUALIZAMOS LA LISTA DE ARCHIVOS TEMPORALES
						cargarEnlacesDescargas(); //FUNCIÓN PARA RECARGAR LA LISTA DE ARCHIVOS TEMPORALES
						alert(`El archivo ${archivo} ha sido eliminado.`); //ALERTA EN CASO DE QUE EL ARCHIVO SE ELIMINE DE MANERA CORRECTA
					} else {
						throw new Error('Error al eliminar el archivo.'); //EN CASO DE QUE NO SE ELIMINE DE MANERA CORRECTA
					}
				})
				.catch(error => {
					console.error('Error al eliminar el archivo temporal:', error); //MENSAJE DENTRO DE LA CONSOLA DE SPRING
				});
		}

		//EVENTO QUE INICIA CUANDO SE ABRE EL MODAL DE DESCARGAS
		document.getElementById('modalDescargas').addEventListener('show.bs.modal', cargarEnlacesDescargas);

		//EVENTO CUANDO SE DA CLIC EN EL BOTÓN DE DESCARGAR DENTRO DEL MODAL
		document.getElementById('descargaLinkContainer').addEventListener('click', function (event) {
			if (event.target.tagName === 'BUTTON' && event.target.classList.contains('btn-descargar')) {
				const archivoDescargado = event.target.dataset.nombre;
				if (archivoDescargado) {
					//DESCARGAMOS EL ARCHIVO
					window.location.href = `/descargas/${archivoDescargado}`;

					//MOSTRAMOS LA ALERTA DE LA DESCARGA EXITOSA
					alert(`Archivo descargado exitosamente: ${archivoDescargado}`);

					//ACTUALIZAMOS LA LISTA DE LOS ARCHIVOS TEMPORALES DENTRO DEL MODAL
					cargarEnlacesDescargas();
				}
			}
		});
	</script>

	<script type="text/javascript"> //ALERTA DE ELIMINAR USUARIO
		function mensajeEliminar() {
			alert("Usuario eliminado correctamente.");
		}
	</script>

	<script type="text/javascript"> //ALERTA DE ACTUALIZAR USUARIO
		function mensajeUserActualizado() {
			alert("Datos actualizados correctamente.");
		}
	</script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
		integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</body>

</html>